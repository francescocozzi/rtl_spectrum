<!DOCTYPE html>
<html>
<head>
    <title>RTL-SDR Spectrum Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .chart-container {
            height: 400px;
            margin-bottom: 20px;
        }
        .iq-container {
            height: 300px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mt-4 mb-4">RTL-SDR Spectrum Analyzer</h1>
        
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="centerFreq" class="form-label">Frequenza Centrale (MHz)</label>
                <input type="number" class="form-control" id="centerFreq" value="433">
            </div>
            <div class="col-md-4">
                <label for="sampleRate" class="form-label">Sample Rate (MS/s)</label>
                <input type="number" class="form-control" id="sampleRate" value="2.4" step="0.1">
            </div>
            <div class="col-md-4">
                <label for="gain" class="form-label">Gain (dB)</label>
                <select class="form-control" id="gain">
                    <option value="auto">Auto</option>
                    <option value="0">0 dB</option>
                    <option value="10">10 dB</option>
                    <option value="20">20 dB</option>
                    <option value="30">30 dB</option>
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col">
                <button class="btn btn-primary" onclick="updateParams()">Aggiorna Parametri</button>
            </div>
        </div>

        <div id="statusMessage" class="alert d-none" role="alert"></div>

        <div class="row mb-3">
            <div class="col">
                <p id="currentSettings" class="text-muted">
                    <strong>Impostazioni Attuali:</strong> Caricamento...
                </p>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div id="spectrumChart" class="chart-container"></div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div id="iqTimeChart" class="iq-container"></div>
            </div>
            <div class="col-md-6">
                <div id="iqConstellation" class="iq-container"></div>
            </div>
        </div>
    </div>

    <script>
        let spectrumChart = null;
        let iqTimeChart = null;
        let iqConstellation = null;

        // Inizializzazione grafici
        function initCharts() {
            // Spettro
            Plotly.newPlot('spectrumChart', [{
                x: [],
                y: [],
                mode: 'lines',
                name: 'Potenza (dB)'
            }], {
                title: 'Spettro',
                xaxis: { title: 'Frequenza (MHz)' },
                yaxis: { title: 'Potenza (dB)', range: [-70, 0] }
            });

            // IQ nel tempo
            Plotly.newPlot('iqTimeChart', [
                {
                    x: [],
                    y: [],
                    mode: 'lines',
                    name: 'I'
                },
                {
                    x: [],
                    y: [],
                    mode: 'lines',
                    name: 'Q'
                }
            ], {
                title: 'Segnale IQ nel tempo',
                xaxis: { title: 'Tempo (s)' },
                yaxis: { title: 'Ampiezza', range: [-1, 1] }
            });

            // Costellazione IQ
            Plotly.newPlot('iqConstellation', [{
                x: [],
                y: [],
                mode: 'markers',
                type: 'scatter',
                name: 'IQ'
            }], {
                title: 'Costellazione IQ',
                xaxis: { title: 'I', range: [-1, 1] },
                yaxis: { title: 'Q', range: [-1, 1] },
                shapes: [{
                    type: 'circle',
                    x0: -1, y0: -1,
                    x1: 1, y1: 1,
                    line: {
                        color: 'rgba(128, 128, 128, 0.5)',
                        dash: 'dash'
                    }
                }]
            });
        }

        function updateCharts() {
            fetch('/get_spectrum')
                .then(response => response.json())
                .then(data => {
                    // Aggiorna spettro
                    Plotly.update('spectrumChart', {
                        x: [data.frequencies],
                        y: [data.powers]
                    });

                    // Aggiorna grafici IQ
                    Plotly.update('iqTimeChart', {
                        x: [[...data.iq_data.time], [...data.iq_data.time]],
                        y: [[...data.iq_data.i], [...data.iq_data.q]]
                    });

                    Plotly.update('iqConstellation', {
                        x: [data.iq_data.i],
                        y: [data.iq_data.q]
                    });

                    // Aggiorna impostazioni correnti
                    document.getElementById('currentSettings').innerHTML = 
                        `<strong>Impostazioni Attuali:</strong> Freq: ${data.current_settings.center_freq.toFixed(1)} MHz, ` +
                        `Rate: ${data.current_settings.sample_rate.toFixed(1)} MS/s, ` +
                        `Gain: ${data.current_settings.gain}`;
                })
                .catch(console.error);
        }

        function updateParams() {
            const params = {
                center_freq: parseFloat(document.getElementById('centerFreq').value) * 1e6,
                sample_rate: parseFloat(document.getElementById('sampleRate').value) * 1e6,
                gain: document.getElementById('gain').value
            };

            fetch('/update_params', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(params)
            })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('statusMessage');
                if (data.status === 'success') {
                    statusDiv.className = 'alert alert-success';
                    statusDiv.textContent = 'Parametri aggiornati con successo';
                } else {
                    statusDiv.className = 'alert alert-danger';
                    statusDiv.textContent = data.message || 'Errore nell\'aggiornamento dei parametri';
                }
                statusDiv.classList.remove('d-none');
                setTimeout(() => statusDiv.classList.add('d-none'), 3000);
            })
            .catch(error => {
                console.error('Error:', error);
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.className = 'alert alert-danger';
                statusDiv.textContent = 'Errore nella comunicazione con il server';
                statusDiv.classList.remove('d-none');
                setTimeout(() => statusDiv.classList.add('d-none'), 3000);
            });
        }

        // Inizializza i grafici e avvia l'aggiornamento periodico
        initCharts();
        setInterval(updateCharts, 100);
    </script>
</body>
</html>