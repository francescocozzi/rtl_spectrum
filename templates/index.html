<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTL-SDR Spectrum Analyzer</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <style>
        .chart-container {
            height: 400px;
            margin-bottom: 20px;
        }
        
        .iq-container {
            height: 300px;
            margin-bottom: 20px;
        }
        
        .signal-info {
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mt-4 mb-4">RTL-SDR Spectrum Analyzer</h1>
        
        <div class="row mb-3">
						<div class="col-md-4">
						    <div class="form-group">
						        <label for="centerFreq">Frequenza Centrale (MHz)</label>
						        <input type="number" 
						               class="form-control" 
						               id="centerFreq" 
						               value="100" 
						               step="0.1" 
						               min="0" 
						               max="2000">
						        <small class="form-text text-muted">Usa il punto per i decimali (es. 100.7)</small>
						    </div>
						</div>
            
            <div class="col-md-4">
                <div class="form-group">
                    <label for="sampleRate">Sample Rate (MS/s)</label>
                    <input type="number" class="form-control" id="sampleRate" value="2.4">
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="form-group">
                    <label for="gain">Gain (dB)</label>
                    <select class="form-control" id="gain">
                        <option value="auto">Auto</option>
                        <option value="0">0 dB</option>
                        <option value="10">10 dB</option>
                        <option value="20">20 dB</option>
                        <option value="30">30 dB</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col">
                <button id="updateParams" class="btn btn-primary">Aggiorna Parametri</button>
            </div>
        </div>
        
        <div id="statusMessage" class="alert d-none" role="alert"></div>
        
        <div class="row mb-3">
            <div class="col">
                <p><strong>Impostazioni Attuali:</strong> <span id="currentSettings">Caricamento...</span></p>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div id="spectrumChart" class="chart-container"></div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div id="iqTimeChart" class="iq-container"></div>
            </div>
            <div class="col-md-6">
                <div id="iqConstellation" class="iq-container"></div>
            </div>
        </div>

        <!-- Sezione Analisi del Segnale -->
				<div class="row mt-3">
				    <div class="col">
				        <div class="card">
				            <div class="card-header">
				                <h5 class="mb-0">Analisi Segnale Selezionato</h5>
				            </div>
				            <div class="card-body">
				                <div class="row">
				                    <div class="col-md-3">
				                        <div class="signal-info">
				                            <strong>Frequenza Centrale:</strong>
				                            <span id="selectedFreq">-</span> MHz
				                        </div>
				                    </div>
				                    <div class="col-md-3">
				                        <div class="signal-info">
				                            <strong>Modulazione:</strong>
				                            <span id="modulation">-</span>
				                        </div>
				                    </div>
				                    <div class="col-md-3">
				                        <div class="signal-info">
				                            <strong>Larghezza di banda:</strong>
				                            <span id="bandwidth">-</span>
				                        </div>
				                    </div>
				                    <div class="col-md-3">
				                        <div class="signal-info">
				                            <strong>Confidenza:</strong>
				                            <span id="confidence">-</span>
				                        </div>
				                    </div>
				                </div>
				            </div>
				        </div>
				    </div>
				</div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let updateTimer;
        const statusMessage = document.getElementById('statusMessage');
        
        // Funzione per mostrare messaggi di stato
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = `alert ${isError ? 'alert-danger' : 'alert-success'}`;
            statusMessage.classList.remove('d-none');
            setTimeout(() => statusMessage.classList.add('d-none'), 3000);
        }
        
        // Funzione per aggiornare l'analisi del segnale
        function updateSignalAnalysis(signalInfo) {
            if (signalInfo) {
                document.getElementById('modulation').textContent = signalInfo.modulation;
                document.getElementById('bandwidth').textContent = `${(signalInfo.bandwidth/1e6).toFixed(2)} MHz`;
                document.getElementById('peakPower').textContent = `${signalInfo.peak_power.toFixed(1)} dB`;
                document.getElementById('confidence').textContent = `${(signalInfo.confidence * 100).toFixed(0)}%`;
            }
        }
        
        // Funzione per aggiornare lo spettro
        function updateSpectrum() {
            fetch('/get_spectrum')
                .then(response => response.json())
                .then(data => {
                    // Aggiorna impostazioni correnti
                    const settings = data.current_settings;
                    document.getElementById('currentSettings').textContent = 
                        `Freq: ${settings.center_freq.toFixed(2)} MHz, Rate: ${settings.sample_rate.toFixed(2)} MS/s, Gain: ${settings.gain}`;
                    
												// Nel codice JavaScript esistente, modifichiamo la creazione del grafico spettro
												Plotly.newPlot('spectrumChart', [{
												    x: data.frequencies,
												    y: data.powers,
												    type: 'scatter',
												    mode: 'lines',
												    name: 'Spectrum'
												}], {
												    title: 'Spettro RF',
												    xaxis: { 
												        title: 'Frequenza (MHz)',
												        rangeslider: {}, // Aggiunge uno slider per lo zoom
												    },
												    yaxis: { title: 'Potenza (dB)' },
												    dragmode: 'select',  // Abilita la selezione
												}, {
												    modeBarButtonsToAdd: [{
												        name: 'Analizza segnale selezionato',
												        icon: Plotly.Icons.zoom,
												        click: function(gd) {
												            analyzeSelectedSignal(gd);
												        }
												    }]
												});

												// Funzione per gestire la selezione
												function analyzeSelectedSignal(gd) {
												    const selection = gd.layout.xaxis.range;
												    if (!selection) return;

												    const [startFreq, endFreq] = selection;
												    fetch('/analyze_signal', {
												        method: 'POST',
												        headers: {
												            'Content-Type': 'application/json'
												        },
												        body: JSON.stringify({
												            start_freq: startFreq,
												            end_freq: endFreq
												        })
												    })
												    .then(response => response.json())
												    .then(data => updateSignalAnalysis(data));
												}
                    
                    // Aggiorna grafici IQ
                    const iqData = data.iq_data;
                    
                    // Grafico temporale IQ
                    Plotly.newPlot('iqTimeChart', [
                        {
                            x: iqData.time,
                            y: iqData.i,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'I'
                        },
                        {
                            x: iqData.time,
                            y: iqData.q,
                            type: 'scatter',
                            mode: 'lines',
                            name: 'Q'
                        }
                    ], {
                        title: 'IQ Time Domain',
                        xaxis: { title: 'Tempo (s)' },
                        yaxis: { title: 'Ampiezza' }
                    });
                    
                    // Costellazione IQ
                    Plotly.newPlot('iqConstellation', [{
                        x: iqData.i,
                        y: iqData.q,
                        type: 'scatter',
                        mode: 'markers',
                        marker: { size: 3 },
                        name: 'IQ'
                    }], {
                        title: 'IQ Constellation',
                        xaxis: { title: 'I' },
                        yaxis: { title: 'Q' }
                    });
                    
                    // Aggiorna analisi del segnale
                    if (data.signal_info) {
                        updateSignalAnalysis(data.signal_info);
                    }
                })
                .catch(error => {
                    console.error('Errore nel recupero dei dati:', error);
                    showStatus('Errore nel recupero dei dati', true);
                });
        }
        
        // Gestione aggiornamento parametri
        document.getElementById('updateParams').addEventListener('click', () => {
            const params = {
                center_freq: parseFloat(document.getElementById('centerFreq').value) * 1e6,
                sample_rate: parseFloat(document.getElementById('sampleRate').value) * 1e6,
                gain: document.getElementById('gain').value
            };
            
            fetch('/update_params', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(params)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus('Parametri aggiornati con successo');
                } else {
                    showStatus(data.message || 'Errore nell\'aggiornamento dei parametri', true);
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                showStatus('Errore nella comunicazione con il server', true);
            });
        });
        
        // Avvio aggiornamento periodico
        function startUpdates() {
            updateSpectrum();
            updateTimer = setInterval(updateSpectrum, 100);
        }
        
        // Gestione dell'uscita
        window.addEventListener('beforeunload', () => {
            clearInterval(updateTimer);
        });
        
        // Avvio iniziale
        startUpdates();
    </script>
</body>
</html>